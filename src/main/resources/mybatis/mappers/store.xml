<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="store">

	<resultMap id="StoreVo" type="com.lunchwb.vo.StoreVo">
		<result column="store_no" property="storeNo" />
		<result column="menu_2nd_cate_no" property="menu2ndCateNo" />
		<result column="store_name" property="storeName" />
		<result column="store_road_address" property="storeRoadAddress" />
		<result column="store_old_address" property="storeOldAddress" />
		<!-- <result column="store_opening_hours" property="storeOpeningHours" /> -->
		<!-- <result column="store_breaktime" property="storeBreaktime" /> -->
		<result column="visit_count" property="visitCnt" />
		<result column="rating_bujang" property="ratingBujang" />
	</resultMap>
	

	<select id="guestStoreRecommend" parameterType="map" resultType="StoreVo">
		<![CDATA[
			SELECT store_no storeNo
			       ,menu_2nd_cate_no menu2ndCateNo
			       ,store_name storeName
			       ,store_road_address storeRoadAddress
			       ,rating_bujang ratingBujang
			       ,distance
			       ,score
			FROM (SELECT s.store_no, s.menu_2nd_cate_no, s.store_name, s.store_road_address, b.rating_bujang
			             ,ROUND(SQRT(POWER(ABS(s.store_x-#{gps.gpsX})*COS(37)*6400000*2*3.14/360, 2) + POWER(ABS(s.store_y-#{gps.gpsY})*6400000*2*3.14/360, 2)), 0) distance
			             ,(NVL(v.cnt, 0)/10 + r.rating_naver * 50 + NVL(b.rating_bujang, 0) * 50) score
			      FROM   store s, rating_others r, food_2nd_category f
			             ,(SELECT store_no, COUNT(*) cnt 
			               FROM visited 
			               GROUP BY store_no) v
			             ,(SELECT store_no, AVG(user_score) rating_bujang
			               FROM review, visited 
			               WHERE review.visited_no = visited.visited_no 
			               GROUP BY visited.store_no) b
			      WHERE  s.store_no = r.store_no
			      AND    s.store_no = b.store_no(+)
			      AND    s.store_no = v.store_no(+)
			      AND    s.menu_2nd_cate_no = f.menu_2nd_cate_no
	    ]]>
		
		<foreach collection="filter_excluded" item="cate_1st">
	              AND    f.menu_1st_cate_no != #{cate_1st}
		</foreach>
			  
		<![CDATA[
		         AND    ((r.rating_naver >= 4.3 AND r.rating_kakao >= 3) OR (r.rating_naver >= 4.5 AND r.rating_kakao = 0)) 
			     ORDER BY score DESC)
		    WHERE  distance <= 1000
		    AND    ROWNUM <= 15
		    ORDER BY DBMS_RANDOM.value;
		]]>
	</select>
	
	
	<select id="basicStoreInfo" parameterType="int" resultMap="StoreVo">
		SELECT  s.store_no
		        , store_name
				, menu_2nd_cate_name
				, store_road_address
		        , visit_count
		        , rating_bujang
		FROM store s
		     , food_2nd_category f
		     , (SELECT COUNT(visited_no) visit_count
		        FROM visited
		        WHERE store_no = #{storeNo} ) 
		     , (SELECT  ROUND(SUM(user_score)/COUNT(user_score), 2) rating_bujang
		        FROM review r, visited v
		        WHERE v.visited_no = r.visited_no
		        AND v.store_no = 8) 
		WHERE s.menu_2nd_cate_no = f.menu_2nd_cate_no
		AND s.store_no = #{storeNo}
	</select>
	
	<select id="storeTime" parameterType="int" resultType="map">
		SELECT  store_opening_hours storeOpeningHours
				, store_breaktime storeBreaktime
		FROM store
		WHERE store_no = #{storeNo}
	</select>
	
</mapper>